---
layout: page
title: "给输入法接入AI语言大模型"
permalink: /给输入法接入AI语言大模型
---

# 给输入法接入AI语言大模型

## 背景

自从看到网上各家输入法被爆出隐私问题后，我就开始使用Rime这个开源输入法，配置难对我来说不是问题，但是它的输入效果比不上国内商业输入法的，输入的一长，它的展示的句子就毫无逻辑，于是我就养成了逐个词输入的习惯，特别慢，每次要看一遍词语再选择

## 第一次尝试：微调大模型

接入语言大模型就是最好的解决方法很早开始我就思考过这个项目，知道上个月才开始尝试，最开始我收集了2万条数据微调Qwen2.5 7B大模型，想让他输入拼音，返回中文

**不得不说阿里云的百炼平台提供了特别方便的服务，只要提供好数据喂进去，我当时训练时根本没写一点代码就完成了，价格也在可接受范围内**

优惠链接：
[阿里云部署AI应用](https://dashi.aliyun.com/activity/aigc?userCode=a7qtiysh)
[部署大模型](https://www.aliyun.com/daily-act/ecs/ecs25srdeepseek?userCode=a7qtiysh)

我花了40多训练了7个多小时，得到了这样的模型：

* 幻觉极重，输入的拼音与输出的不匹配，你可以试试让deepseek当你的输入法，就可以得到相同的效果
* 延迟很大，因为大模型的参数很大，本来就是不合适的

我咨询了AI它让我整理数据继续微调，后面我并没有照做，而是察觉到模型架构应该改变

**不过，当时我还没弄清楚这种架构根本不现实**

## 第二次尝试：从零开始训练

继续根据AI的建议，更换了Seq2Seq的架构，并指导我训练这个模型，所有的训练代码都是AI生成的，我只负责数据处理部分，最后我得到了一个大概20M参数量的输入拼音序列，返回中文的模型，效果还不错，至少没有幻觉了，长句输入也不错

在开始前我还微调了一个Seq2Seq模型，结果模型通过填充<pad>作弊，更是废物，于是才完全抛弃了微调模型这条路

**到这里我还没弄清楚这种架构根本不现实**

刚才的模型没有缓存的功能，没办法适应输入又删除的场景，于是又搞来一遍，但是忘记叫AI写代码时确定参数量了，10M参数量的模型幻觉又出现了。每次训练真的很麻烦，加上分词器的设计混乱，我又开始考虑新的架构

## 接近成功

一步一步的让AI给我设计新架构，我提到了词向量，于是这个最终架构就诞生了：

使用语言大模型根据语境预测下一个词，然后计算输入法产生的候选词与这个词的相似度，这里参考了词向量的原理，使用向量相似度计算，这样就完美了，都不用设计新模型

实际上这也触及到了输入法和核心原理，到这里才弄明白只有这样才是正确的

### Rime原理简介

1. 字符接收与编码转换
当用户敲击键盘时，前端程序会捕获按键事件，并将其发送给 Rime 引擎。引擎接收到按键后，会根据当前的输入方案，将其转化为内部的输入码（input code）。例如，用户敲下 's' 'h' 'u' 'a' 'n' 'g'，Rime 就会得到 shuang 这个字符串。

2. 拼写运算与音节切分
* 这是 Rime 最具特色的部分。内核会利用在编译阶段生成的“拼写运算”查找表，对输入码进行处理。
* 音节切分： 如果输入方案是拼音，引擎会尝试将 shuang 切分为 shuang 这个音节。
* 双拼或模糊音处理： 如果是双拼方案，shuang 可能会被映射为 u。如果是模糊音，zh 可能与 z 等价。
* 这个阶段产生的结果是音节码（syllable code），它代表了用户想要表达的语音信息。

3. 词典查询与候选项生成（Translator（翻译器））
Rime 引擎拿着音节码，开始在编译好的词典索引中进行高速查询。
* 全拼匹配： shuang 可能会匹配到“双”、“霜”、“爽”等词语。
* 短语匹配： 如果用户输入 shuang xue，引擎会尝试匹配“双学”、“霜雪”等词组。
这个阶段会返回一个候选项列表，包含了所有可能的词语和短语。

4. 语言模型与排序（Filter（过滤器））
Rime 引擎会使用一个简化的语言模型来对候选项进行排序。这个模型会考虑：
* 词频： 出现频率高的词语会被优先排序。
* 用户词典： 用户自定义的词语和短语会具有最高的优先级。
* 上下文： 如果用户已经输入了一部分句子，Rime 会根据前文来预测后文，并调整排序。
经过排序后，Rime 引擎将最终的候选项列表发送回前端，由前端负责将其渲染到屏幕上。

也就是这个语言模型太过拉跨的微调，我的决定是正确的

## 最后

最后推理代码也是AI写的，虽然AI在大型项目上很拉跨，但写一个Python小脚本还是很方便的，速度很快，只要我们的提示词够精准，把步骤列表列好

别看这个项目只有很少的代码，实际上我的电脑里面已经又十几版这个项目的不同实现了，有Python和Rust的，但拿得出手的只有这个了

审查AI的代码也是很头疼的问题呀，还有写提示词，而且要反复重来无数次，接入Rime的部分实在是没有精力来做了，留个原型在这吧

希望：
* 组建一个社区来发展和维护项目
* 用一种静态语言重写，更希望Rust，因为关于AI的生态好包管理也很方便，C++也行吧，但是我第一次尝试重写这个项目的时候被C++的包管理逼疯了，后面就转向Rust，当然也没有写成
* 来个人把这东西接入Rime
